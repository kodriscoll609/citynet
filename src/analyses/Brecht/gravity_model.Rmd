---
title: "gravity_model"
author: "Brecht Nijman"
date: "6/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Data & Packages



```{r libraries}
library(tidyverse)
library(glmnet)
# library(readr)
library(magrittr)
library(ggplot2)
library(firatheme)
library(stargazer)

```

```{r}
# knitr::root.dir("")
```

```{r}
getwd()
```


```{r load edges}
setwd("/Users/brecht/Documents/citynet_2")
edges <- read_delim("citynet/src/output/gravity_df_DUM.csv",
                         ";", escape_double = FALSE, 
                         col_types = 
                           cols(border_DUM = col_factor(levels = c("0", "1")), 
                                FR_con = col_factor(levels = c("0", "1")), 
                                FR_int = col_factor(levels = c("0", "1")), 
                                EN_con = col_factor(levels = c("0", "1")), 
                                EN_int = col_factor(levels = c("0", "1"))), 
                         trim_ws = TRUE)

edges <- tibble(edges)
head(edges)
```


```{r}
setwd("/Users/brecht/Documents/citynet_2")
nodes <- read_delim("citynet/src/output/nodes.csv",
                         ";", escape_double = FALSE, 
                         col_types = 
                           cols(FR_DUM = col_factor(levels = c("0", "1")), 
                                EN_DUM = col_factor(levels = c("0", "1"))), 
                         trim_ws = TRUE)

nodes <- tibble(nodes)
#nodes <- select(nodes, -c(X1))
head(nodes)
```

## Nodes
```{r create variable FR_EN}
nodes <- mutate(nodes,
       lang = ifelse(EN_DUM == 1, "EN", ifelse(FR_DUM == 1, "FR", "OTHER")))
```

```{r}
nodes
```
```{r}
ggplot(nodes, aes(x=log(en_deg_prop), y=log(fr_deg_prop), shape=lang)) +
  geom_point(aes(col=CC)) +
  geom_abline()
```

```{r}
ggplot(nodes, aes(x=log(en_deg_prop), y=log(fr_deg_prop), shape=lang)) +
  geom_point(aes(col=lang)) +
  scale_colour_grey(start = 0.2, end = 0.6) +
  geom_abline() +
  theme_light() 
```


```{r, fig.dim=}
degree_cor <-
  ggplot(nodes, aes(x=log(en_deg_prop), y=log(fr_deg_prop), shape=lang)) +
  geom_abline(slope = 1, intercept = 0, alpha = .5) +
  geom_point(aes(col=lang)) +
  xlim(-5, 3.5) +
  ylim(-5, 3.5) +
  xlab("Proportional degree centrality in the English network (ln)")+
  ylab("Proportional degree centrality in the French network (ln)")+
  scale_colour_brewer(palette = "Set2", labels=c('English', 'French', 'Other'))+
  scale_shape(labels=c('English', 'French', 'Other')) + 
  labs(col="Language Sphere", shape="Language Sphere") +
  theme_classic() +
  theme(text = element_text(size = 9)) +
  theme(legend.position = c(.9, .2)) +
  theme(panel.grid.major = element_line(linetype = 'dashed', colour = "grey50", size = .05),
        panel.grid.minor = element_line(linetype = 'dashed', colour = "grey50", size = .05),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))

degree_cor

```
cooc_scatter2 <-
  ggplot(edges_nz, aes(log(col_prop_en), log(col_prop_fr), fill=lang_int, shape=lang_int)) +
  geom_point(size = 2.5) +
  xlim(-10, 1) +
  ylim(-10, 1) +
  geom_abline(alpha = .5) +
  scale_fill_brewer(palette = "Set2", labels=c('English', 'French', 'Other')) +
  scale_shape_manual(values = c(21, 22, 23), labels=c('English', 'French', 'Other')) +
  # scale_shape(labels=c('Both','English', 'French', 'Other')) +
  labs(fill="Language Sphere", shape="Language Sphere") +
  xlab("Proportional city-pair co-occurence in the English network (log)")+
  ylab("Proportional city-pair co-occurence in the French network (log)") +
  theme_classic() +
  # theme(text = element_text(family = 'serif', size = 9)) +
  theme(legend.position = c(.9, .2)) +
  theme(panel.grid.major = element_line(linetype = 'dashed', colour = "grey50", size = .05),
        panel.grid.minor = element_line(linetype = 'dashed', colour = "grey50", size = .05),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))

cooc_scatter2
```{r}
degree_cor2 <-
  ggplot(nodes, aes(x=log(en_deg_prop), y=log(fr_deg_prop), shape=lang)) +
  geom_abline(slope = 1, intercept = 0, alpha = .5) +
  geom_point(aes(fill=lang), size = 2.5) +
  xlim(-5, 3.5) +
  ylim(-5, 3.5) +
  xlab("Proportional degree centrality in the English network (ln)")+
  ylab("Proportional degree centrality in the French network (ln)")+
  scale_fill_brewer(palette = "Set2", labels=c('English', 'French', 'Other'))+
  scale_shape_manual(values = c(21, 22, 23), labels=c('English', 'French', 'Other')) +
  labs(fill="Language Sphere", shape="Language Sphere") +
  theme_classic() +
  theme(text = element_text(family='serif', size = 9)) +
  theme(legend.position = c(.9, .2)) +
  theme(panel.grid.major = element_line(linetype = 'dashed', colour = "grey50", size = .05),
        panel.grid.minor = element_line(linetype = 'dashed', colour = "grey50", size = .05),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))

degree_cor2
```


```{r}
ggsave("degreefigure.png", height = 4, width = 5)
```


## Edges

```{r}
head(edges)
```

```{r}
# edges <- mutate(edges,
#        lang = ifelse(EN_con == 1, "EN", ifelse(FR_con == 1, "FR", "OTHER")))

edges <- mutate(edges,
       lang = ifelse((EN_con == 1 & FR_con == 0), "EN", ifelse((EN_con == 0 & FR_con == 1) , "FR", ifelse((EN_con == 1 & FR_con == 1), "BOTH", "OTHER"))))

edges <- mutate(edges,
       lang_int = ifelse(EN_int == 1, "EN", ifelse(FR_int == 1, "FR", "OTHER")))
```

```{r}
# subset without 0s
edges_nz <- subset(edges, col_en > 0)
edges_nz <- subset(edges_nz, col_fr > 0)

```

```{r}
# cooc_scatter <-
#   ggplot(edges_nz, aes(log(col_prop_en), log(col_prop_fr), fill=lang, shape=lang)) +
#   geom_point(size = 2.5) +
#   xlim(-10, 1) +
#   ylim(-10, 1) +
#   geom_abline(alpha = .5) +
#   scale_fill_brewer(palette = "BrBG", labels=c('Both','English', 'French', 'Other')) +
#   scale_shape_manual(values = c(21, 22, 23, 24), labels=c('Both','English', 'French', 'Other')) +
#   # scale_shape(labels=c('Both','English', 'French', 'Other')) +
#   labs(fill="Language Sphere", shape="Language Sphere") +
#   xlab("Proportional city-pair co-occurence in the English network (log)")+
#   ylab("Proportional city-pair co-occurence in the French network (log)") +
#   theme_classic() +
#   # theme(text = element_text(family = 'serif', size = 9)) +
#   theme(legend.position = c(.9, .2)) +
#   theme(panel.grid.major = element_line(linetype = 'dashed', colour = "grey50", size = .05),
#         panel.grid.minor = element_line(linetype = 'dashed', colour = "grey50", size = .05),
#         legend.background = element_blank(),
#         legend.box.background = element_rect(colour = "black"))
# 
# cooc_scatter
```


```{r}
cooc_scatter2 <-
  ggplot(edges_nz, aes(log(col_prop_en), log(col_prop_fr), fill=lang_int, shape=lang_int)) +
  geom_point(size = 2.5) +
  xlim(-10, 1) +
  ylim(-10, 1) +
  geom_abline(alpha = .5) +
  scale_fill_brewer(palette = "Set2", labels=c('English', 'French', 'Other')) +
  scale_shape_manual(values = c(21, 22, 23), labels=c('English', 'French', 'Other')) +
  # scale_shape(labels=c('Both','English', 'French', 'Other')) +
  labs(fill="Language Sphere", shape="Language Sphere") +
  xlab("Proportional city-pair co-occurence in the English network (ln)")+
  ylab("Proportional city-pair co-occurence in the French network (ln)") +
  theme_classic() +
  theme(text = element_text(family = 'serif', size = 9)) +
  theme(legend.position = c(.9, .2)) +
  theme(panel.grid.major = element_line(linetype = 'dashed', colour = "grey50", size = .05),
        panel.grid.minor = element_line(linetype = 'dashed', colour = "grey50", size = .05),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))

cooc_scatter2
```

```{r}
ggsave("coocfigure.png", height = 4, width = 5)
```



```{r}

# subset without 0s
edges_nz_en <- subset(edges, col_en > 0)
edges_nz_fr <- subset(edges, col_fr > 0)

```


```{r}
lm.fit <- lm(log(col_en) ~ log(POP_A) + log(POP_B) + log(distance), edges_nz)
summary(lm.fit)
```

```{r}
lm.fit1 <- lm(log(col_fr) ~ POP_A + POP_B + distance + border_DUM, edges_nz)
summary(lm.fit1)
```

```{r}
plot(lm.fit1)
```

```{r}
nooutliers_df <-
  edges_nz[-1,]

dim(nooutliers_df)
```


```{r}
plot(lm.fit1)
```



```{r}
# subset only cities larger than 1mil
smaller_df <-
  edges_nz %>% 
  filter(POP_A > 999 & POP_B > 999)

head(smaller_df)
```

```{r}
lm.fit2 <- lm(col_fr ~ POP_A + POP_B + distance, smaller_df)
summary(lm.fit2)
```

```{r}
# french model
lm.fit3 <- lm(collocation_fr ~ POP_A + POP_B + distance, gravity_df)
summary(lm.fit3)
```

```{r}
# french model on cities greater than 1 million
lm.fit4 <- lm(collocation_fr ~ POP_A + POP_B + distance, smaller_df)
summary(lm.fit4)
```

```{r}
# excluding 0s
no_zeros_fr <- 
  gravity_df %>% 
  filter(collocation_fr > 0)

```

```{r}
# lm.fit5 <- lm(collocation_fr ~ POP_A + POP_B + distance, no_zeros_fr)
# summary(lm.fit5)
```

```{r}
# ggplot(gravity_df) +
#   geom_histogram(aes(log10(gravity_df$collocation_en), alpha = .8, fill = 'red'), bins = 80) +
#   geom_histogram(aes(log10(gravity_df$collocation_fr), alpha = .8), bins = 80)
```

```{r}
# ggplot(gravity_df) +
#  geom_histogram(aes(gravity_df$collocation_en_norm, alpha = .8, fill = 'red')) +
#  geom_histogram(aes(gravity_df$collocation_fr_norm, alpha = .8))
```

```{r}
# with border dummy
lm.fit6 <- lm(collocation_fr ~ POP_A + POP_B + distance + border_DUM,
              gravity_df)
summary(lm.fit6)
```

```{r}
# with border dummy & french dummy
lm.fit7 <- lm(collocation_fr ~ POP_A + POP_B + distance + border_DUM + FR_DUM,
              gravity_df)
summary(lm.fit7)
```

```{r}
# with border dummy & double_french dummy
lm.fit8 <- lm(collocation_fr ~ POP_A + POP_B + distance + border_DUM + FR_int,
              gravity_df)
summary(lm.fit8)
```

```{r}
# with border dummy for english
lm.fit9 <- lm(collocation_en ~ POP_A + POP_B + distance + border_DUM,
              gravity_df)
summary(lm.fit9)
```

```{r}
# with border dummy and EN_DUM
lm.fit10 <- lm(collocation_en ~ POP_A + POP_B + distance + border_DUM + EN_DUM,
              gravity_df)
summary(lm.fit10)
```

```{r}
# with border dummy and EN_DUM
lm.fit11 <- lm(collocation_en ~ POP_A + POP_B + distance + border_DUM + EN_int,
              gravity_df)
summary(lm.fit11)
```

```{r}
# with border dummy and EN_int on large cities only
lm.fit12 <- lm(collocation_en ~ POP_A + POP_B + distance + border_DUM + EN_int,
              smaller_df)
summary(lm.fit12)
```

```{r}
# with border dummy and EN_int on large cities only
lm.fit13 <- lm(collocation_fr ~ POP_A + POP_B + distance + border_DUM + FR_int,
              smaller_df)

summary(lm.fit13)
```